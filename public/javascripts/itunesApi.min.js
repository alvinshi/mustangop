var app=angular.module("yemaWebApp",[]),navIndex=1;app.controller("itunesSearchControl",function(a,b){function c(){void 0==a.selectedApp&&void 0==a.appNeedInfo;var c="/myapp/getNeed/"+a.selectedApp.appleId;b.get(c).success(function(c){a.appNeedInfo=c.appNeedInfo;var e="myapp/verify";a.insufficientFund=!1,b.get(e).success(function(b){a.usermoney=b.usermoney,void 0!=a.appNeedInfo.excCount&&d(a.appNeedInfo.excCount,a.usermoney)}),void 0==a.appNeedInfo.taskType&&(a.appNeedInfo.taskType="评论"),"评论"==a.appNeedInfo.taskType?a.appNeedInfo.excUnitPrice=30:a.appNeedInfo.excUnitPrice=25})}function d(b,c){if(void 0!=b){var d=b*a.appNeedInfo.excUnitPrice;d<c?a.insufficientFund=!0:a.insufficientFund=!1}}a.isLoadingMyApp=!0,a.numOfApps=void 0,a.selectedApp=void 0,a.saved=!1;var e="myapp/angular";b.get(e).success(function(b){a.isLoadingMyApp=!1,a.myApps=b.myApps,a.numOfApps=a.myApps.length,a.numOfApps>0&&(a.myApps=a.myApps.sort(function(a,b){return a.createdAt>=b.createdAt}),a.selectedApp=a.myApps[0],c())}),a.selectedAppFunc=function(b){a.saved=!1,a.selectedApp=b,c()};a.progressNum=0,a.searchApp=function(){if(a.isError=0,""!=a.searchUrl){var c="api/itunes/search/"+a.searchKey;a.progressNum=100,console.log("--------- searchApp searchApp"),b.get(c).success(function(b){if(console.log("searchApp"+b),a.appResults=b.appResults,a.progressNum=0,b.errorMsg.length>0)a.isError=1,a.errorMsg=b.errorMsg;else{a.errorMsg="",0==a.appResults.length&&(a.isError=1,a.errorMsg="未找到你搜索的App,请尝试输入它的全称");for(var c=0;c<a.appResults.length;c++){var d=a.appResults[c];d.isMine=!1;for(var e=0;e<a.myApps.length;e++){var f=a.myApps[e];if(f.appleId===d.appleId){d.isMine=!0,console.log(d.appleId+"isMine");break}}}}})}},a.keySearchApp=function(b){var c=window.event?b.keyCode:b.which;13==c&&a.searchApp()},a.chooseMyApp=function(d){var e="myapp/add";b.post(e,{appInfo:d}).success(function(b){if(0==b.errorId||void 0===b.errorId){var e=0;void 0==a.myApps&&(a.myApps=new Array);for(var f=0;f<a.myApps.length;f++){var g=a.myApps[f];if(g.appleId==d.appleId){e=1;break}}0==e&&(a.selectedApp=b.newApp,c(),a.myApps.push(b.newApp),console.log(a.myApps),a.numOfApps++)}else a.errorMsg=b.errorMsg;a.searchKey="",a.appResults=[],$("#addApp_modal").modal("hide")})},a.releaseBtnClick=function(b){a.prepareReleaseApp=b},a.releaseMyApp=function(){var d="myapp/delete",e=a.prepareReleaseApp.appleId;b.post(d,{appid:e}).success(function(b){if(0==b.errorId){console.log("remove app if");for(var d=0;d<a.myApps.length;d++){var f=a.myApps[d];if(f.appleId==e){a.myApps.splice(d,1);break}}}else a.errorMsg=b.errorMsg;a.appResults=[],a.numOfApps--,0==a.numOfApps?(a.selectedApp=void 0,c()):a.prepareReleaseApp==a.selectedApp&&(a.selectedApp=a.myApps[0],c())})},a.saved=!1,a.saveNeed=function(){var c="/myapp/taskneed/"+a.selectedApp.appleId,d={taskType:a.appNeedInfo.taskType,excCount:a.appNeedInfo.excCount,excUnitPrice:a.appNeedInfo.excUnitPrice,screenshotCount:a.appNeedInfo.screenshotCount,searchKeyword:a.appNeedInfo.searchKeyword,ranKing:a.appNeedInfo.ranKing,Score:a.appNeedInfo.Score,titleKeyword:a.appNeedInfo.titleKeyword,commentKeyword:a.appNeedInfo.commentKeyword,detailRem:a.appNeedInfo.detailRem};b.post(c,d).success(function(b){a.errorId=b.errorId,a.errorMsg=b.errorMsg,a.saved=!0})},a.releaseTask=function(){a.saveNeed();var c=!0;if(a.error=Object(),a.error.excCount=!1,a.error.searchKeyword=!1,""!=a.appNeedInfo.excCount&&void 0!=a.appNeedInfo.excCount||(c=!1,a.error.excCount=!0,$("#error").modal("show")),""!=a.appNeedInfo.searchKeyword&&void 0!=a.appNeedInfo.searchKeyword||(c=!1,a.error.searchKeyword=!0,$("#error").modal("show")),void 0!=a.appNeedInfo.excCount){var d=a.appNeedInfo.excCount*a.appNeedInfo.excUnitPrice;console.log(a.usermoney),d>a.usermoney&&($("#meiQian").modal("show"),c=!1)}if(c){console.log("passed"),console.log(a.selectedApp);var e="/myapp/task/"+a.selectedApp.appleId,f={taskType:a.appNeedInfo.taskType,excCount:a.appNeedInfo.excCount,excUnitPrice:document.getElementById("price").value,screenshotCount:a.appNeedInfo.screenshotCount,searchKeyword:a.appNeedInfo.searchKeyword,ranKing:a.appNeedInfo.ranKing,Score:a.appNeedInfo.Score,titleKeyword:a.appNeedInfo.titleKeyword,commentKeyword:a.appNeedInfo.commentKeyword,detailRem:a.appNeedInfo.detailRem,appObjectId:a.selectedApp.appObjectId};b.post(e,f).success(function(b){a.errorId=b.errorId,a.errorMsg=b.errorMsg,$("#releaseTask").modal("show")})}},a.color={color:"#3498db","font-size":"14px"},a.setValue1=function(){document.getElementById("price").value="30"},a.setValue2=function(){document.getElementById("price").value="25"},a.checkText1=function(){a.appNeedInfo.titleKeyword.length>20&&(a.appNeedInfo.titleKeyword=a.appNeedInfo.titleKeyword.substr(0,20),saveStatusChange())},a.checkText2=function(){a.appNeedInfo.commentKeyword.length>40&&(a.appNeedInfo.commentKeyword=a.appNeedInfo.commentKeyword.substr(0,40),saveStatusChange())},a.checkText3=function(){a.appNeedInfo.detailRem.length>140&&(a.appNeedInfo.detailRem=a.appNeedInfo.detailRem.substr(0,140),saveStatusChange())},a.calcuQuantity=function(){a.saved=!1,d(a.appNeedInfo.excCount,a.usermoney)},a.getScreenShot=function(){console.log("runned"),html2canvas(document.getElementById("screenShot"),{onrendered:function(a){var b=document.createElement("a");b.href=a.toDataURL("image/png",1).replace("image/png","image/octet-stream"),b.download="exchange-requirements.png",b.click()},proxy:a.selectedApp.artworkUrl100})},a.addApp=function(a){$("#"+a).popover("toggle")},a.saveStatusChange=function(){a.saved=!1}});