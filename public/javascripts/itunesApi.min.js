var app=angular.module("yemaWebApp",[]),navIndex=1;app.controller("itunesSearchControl",function($scope,$http){function getDemand(){void 0==$scope.selectedApp&&void 0==$scope.appNeedInfo;var getneedUrl="/myapp/getNeed/"+$scope.selectedApp.appleId;$http.get(getneedUrl).success(function(response){$scope.appNeedInfo=response.appNeedInfo;var url="myapp/verify";$scope.insufficientFund=!1,$http.get(url).success(function(response){$scope.usermoney=response.usermoney,void 0!=$scope.appNeedInfo.excCount&&moneyCheck($scope.appNeedInfo.excCount,$scope.usermoney)}),void 0==$scope.appNeedInfo.taskType&&($scope.appNeedInfo.taskType="评论"),"评论"==$scope.appNeedInfo.taskType?$scope.appNeedInfo.excUnitPrice=30:$scope.appNeedInfo.excUnitPrice=25,void 0==$scope.appNeedInfo.screenshotCount&&($scope.appNeedInfo.screenshotCount=3)})}function moneyCheck(amount,accountMoney){if(void 0!=amount){var taskMoney=amount*$scope.appNeedInfo.excUnitPrice;taskMoney<accountMoney?$scope.insufficientFund=!0:$scope.insufficientFund=!1}}var url="myapp/verify";$scope.insufficientFund=!1,$http.get(url).success(function(response){$scope.usermoney=response.usermoney}),$scope.isLoadingMyApp=!0,$scope.numOfApps=void 0,$scope.selectedApp=void 0,$scope.saved=!1;var appsUrl="myapp/angular";$http.get(appsUrl).success(function(response){$scope.isLoadingMyApp=!1,$scope.myApps=response.myApps,$scope.numOfApps=$scope.myApps.length,$scope.numOfApps>0&&($scope.myApps=$scope.myApps.sort(function(a,b){return a.createdAt>=b.createdAt}),$scope.selectedApp=$scope.myApps[0],getDemand())}),$scope.selectedAppFunc=function(app){$scope.saved=!1,$scope.selectedApp=app,getDemand()};$scope.progressNum=0,$scope.searchApp=function(){if($scope.isError=0,""!=$scope.searchUrl){var searchUrl="api/itunes/search/"+$scope.searchKey;$scope.progressNum=100,console.log("--------- searchApp searchApp"),$http.get(searchUrl).success(function(response){if(console.log("searchApp"+response),$scope.appResults=response.appResults,$scope.progressNum=0,response.errorMsg.length>0)$scope.isError=1,$scope.errorMsg=response.errorMsg;else{$scope.errorMsg="",0==$scope.appResults.length&&($scope.isError=1,$scope.errorMsg="未找到你搜索的App,请尝试输入它的全称");for(var i=0;i<$scope.appResults.length;i++){var appRe=$scope.appResults[i];appRe.isMine=!1;for(var j=0;j<$scope.myApps.length;j++){var myApp=$scope.myApps[j];if(myApp.appleId===appRe.appleId){appRe.isMine=!0,console.log(appRe.appleId+"isMine");break}}}}})}},$scope.keySearchApp=function(e){var keycode=window.event?e.keyCode:e.which;13==keycode&&$scope.searchApp()},$scope.chooseMyApp=function(appInfo){var searchUrl="myapp/add";$http.post(searchUrl,{appInfo:appInfo}).success(function(response){if(0==response.errorId||void 0===response.errorId){var flag=0;void 0==$scope.myApps&&($scope.myApps=new Array);for(var i=0;i<$scope.myApps.length;i++){var app=$scope.myApps[i];if(app.appleId==appInfo.appleId){flag=1;break}}0==flag&&($scope.selectedApp=response.newApp,getDemand(),$scope.myApps.push(response.newApp),console.log($scope.myApps),$scope.numOfApps++)}else $scope.errorMsg=response.errorMsg;$scope.searchKey="",$scope.appResults=[],$("#addApp_modal").modal("hide")})},$scope.releaseBtnClick=function(app){$scope.prepareReleaseApp=app},$scope.releaseMyApp=function(){var searchUrl="myapp/delete",appid=$scope.prepareReleaseApp.appleId;$http.post(searchUrl,{appid:appid}).success(function(response){if(0==response.errorId){console.log("remove app if");for(var i=0;i<$scope.myApps.length;i++){var app=$scope.myApps[i];if(app.appleId==appid){$scope.myApps.splice(i,1);break}}}else $scope.errorMsg=response.errorMsg;$scope.appResults=[],$scope.numOfApps--,0==$scope.numOfApps?($scope.selectedApp=void 0,getDemand()):$scope.prepareReleaseApp==$scope.selectedApp&&($scope.selectedApp=$scope.myApps[0],getDemand())})},$scope.saved=!1,$scope.saveNeed=function(){var needUrl="/myapp/taskneed/"+$scope.selectedApp.appleId,needInfo={taskType:$scope.appNeedInfo.taskType,excCount:$scope.appNeedInfo.excCount,excUnitPrice:$scope.appNeedInfo.excUnitPrice,screenshotCount:$scope.appNeedInfo.screenshotCount,searchKeyword:$scope.appNeedInfo.searchKeyword,ranKing:$scope.appNeedInfo.ranKing,Score:$scope.appNeedInfo.Score,titleKeyword:$scope.appNeedInfo.titleKeyword,commentKeyword:$scope.appNeedInfo.commentKeyword,detailRem:$scope.appNeedInfo.detailRem};$http.post(needUrl,needInfo).success(function(response){$scope.errorId=response.errorId,$scope.errorMsg=response.errorMsg,$scope.saved=!0})},$scope.releaseTask=function(){$scope.saveNeed();var flag=!0;if($scope.error=Object(),$scope.error.excCount=!1,$scope.error.searchKeyword=!1,""!=$scope.appNeedInfo.excCount&&void 0!=$scope.appNeedInfo.excCount||(flag=!1,$scope.error.excCount=!0,$("#error").modal("show")),""!=$scope.appNeedInfo.searchKeyword&&void 0!=$scope.appNeedInfo.searchKeyword||(flag=!1,$scope.error.searchKeyword=!0,$("#error").modal("show")),void 0!=$scope.appNeedInfo.excCount){var taskMoney=$scope.appNeedInfo.excCount*$scope.appNeedInfo.excUnitPrice;console.log($scope.usermoney),taskMoney>$scope.usermoney&&($("#meiQian").modal("show"),flag=!1)}if(flag){console.log("passed"),console.log($scope.selectedApp);var needUrl="/myapp/task/"+$scope.selectedApp.appleId,needInfo={taskType:$scope.appNeedInfo.taskType,excCount:$scope.appNeedInfo.excCount,excUnitPrice:document.getElementById("price").value,screenshotCount:$scope.appNeedInfo.screenshotCount,searchKeyword:$scope.appNeedInfo.searchKeyword,ranKing:$scope.appNeedInfo.ranKing,Score:$scope.appNeedInfo.Score,titleKeyword:$scope.appNeedInfo.titleKeyword,commentKeyword:$scope.appNeedInfo.commentKeyword,detailRem:$scope.appNeedInfo.detailRem,appObjectId:$scope.selectedApp.appObjectId};$http.post(needUrl,needInfo).success(function(response){$scope.errorId=response.errorId,$scope.errorMsg=response.errorMsg,$("#releaseTask").modal("show")})}},$scope.color={color:"#3498db","font-size":"14px"},$scope.checkText1=function(){$scope.appNeedInfo.titleKeyword.length>20&&($scope.appNeedInfo.titleKeyword=$scope.appNeedInfo.titleKeyword.substr(0,20),saveStatusChange())},$scope.checkText2=function(){$scope.appNeedInfo.commentKeyword.length>40&&($scope.appNeedInfo.commentKeyword=$scope.appNeedInfo.commentKeyword.substr(0,40),saveStatusChange())},$scope.checkText3=function(){$scope.appNeedInfo.detailRem.length>140&&($scope.appNeedInfo.detailRem=$scope.appNeedInfo.detailRem.substr(0,140),saveStatusChange())},$scope.calcuQuantity=function(){$scope.saved=!1,moneyCheck($scope.appNeedInfo.excCount,$scope.usermoney)},$scope.getScreenShot=function(){console.log("runned"),html2canvas(document.getElementById("screenShot"),{onrendered:function(canvas){var a=document.createElement("a");a.href=canvas.toDataURL("image/png",1).replace("image/png","image/octet-stream"),a.download="exchange-requirements.png",a.click()},proxy:$scope.selectedApp.artworkUrl100})},$scope.addApp=function(id){$("#"+id).popover("toggle")},$scope.saveStatusChange=function(){$scope.saved=!1},$scope.taskTypeChanged=function(){"评论"==$scope.appNeedInfo.taskType?$scope.appNeedInfo.excUnitPrice=30:$scope.appNeedInfo.excUnitPrice=25,$scope.saved=!1}});