var app=angular.module("yemaWebApp",[]),navIndex=1;app.controller("itunesSearchControl",function($scope,$http){function getDemand(){if(void 0==$scope.selectedApp)return void(void 0==$scope.appNeedInfo);var getneedUrl="/myapp/getNeed/"+$scope.selectedApp.appObjectId;$http.get(getneedUrl).success(function(response){$scope.appNeedInfo=response.appNeedInfo;var url="myapp/verify";$scope.insufficientFund=!1,$http.get(url).success(function(response){$scope.usermoney=response.usermoney,void 0!=$scope.appNeedInfo.excCount&&moneyCheck($scope.appNeedInfo.excCount,$scope.usermoney)}),void 0==$scope.appNeedInfo.taskType&&($scope.appNeedInfo.taskType="评论"),"评论"==$scope.appNeedInfo.taskType?$scope.appNeedInfo.excUnitPrice=30:$scope.appNeedInfo.excUnitPrice=20,void 0==$scope.appNeedInfo.screenshotCount&&($scope.appNeedInfo.screenshotCount=3)})}function moneyCheck(amount,accountMoney){if(void 0!=amount){var taskMoney=amount*$scope.appNeedInfo.excUnitPrice;taskMoney>accountMoney?$scope.insufficientFund=!0:$scope.insufficientFund=!1}}var url="myapp/verify";$scope.insufficientFund=!1,$http.get(url).success(function(response){$scope.usermoney=response.usermoney}),$scope.isLoadingMyApp=!0,$scope.numOfApps=10,$scope.selectedApp=void 0,$scope.saved=!1;var appsUrl="myapp/angular";$http.get(appsUrl).success(function(response){$scope.isLoadingMyApp=!1,$scope.numOfApps=response.myApps.length,$scope.numOfApps>0&&($scope.myApps=response.myApps.sort(function(a,b){return a.createdAt>=b.createdAt}),$scope.selectedApp=$scope.myApps[0],$scope.isDisabled=!1,getDemand())}),$scope.selectedAppFunc=function(app){$scope.saved=!1,$scope.selectedApp=app,$scope.isDisabled=!1,getDemand()},$scope.releaseTaskVideo=function(){$("#releaseTaskVideo").modal("hide");var myVideo=document.getElementById("release");myVideo.pause()};$scope.progressNum=0;var searchLocked=!1;$scope.searchApp=function(){if($scope.isError=0,""!=$scope.searchUrl&&0==searchLocked){var searchUrl="api/itunes/search/"+$scope.searchKey;$scope.progressNum=100,console.log("--------- searchApp searchApp"),searchLocked=!0,$http.get(searchUrl).success(function(response){if(searchLocked=!1,console.log("searchApp"+response),$scope.appResults=response.appResults,$scope.progressNum=0,response.errorMsg.length>0)$scope.isError=1,$scope.errorMsg=response.errorMsg;else{$scope.errorMsg=response.errorMsg,$scope.isError=0!=response.errorId;for(var i=0;i<$scope.appResults.length;i++){var appRe=$scope.appResults[i];appRe.isMine=!1;for(var j=0;j<$scope.myApps.length;j++){var myApp=$scope.myApps[j];if(myApp.appleId===appRe.appleId){appRe.isMine=!0,console.log(appRe.appleId+"isMine");break}}}}})}},$scope.keySearchApp=function(e){var keycode=window.event?e.keyCode:e.which;13==keycode&&$scope.searchApp()},$scope.updateApp=function(){$("#updateApp").modal("show"),$scope.isLoadingApp=!0,$scope.errorMsg="";var updateAppURL="/myapp/UpdateApp";$http.post(updateAppURL).success(function(response){$scope.errorId=response.errorId,$scope.errorMsg=response.errorMsg,0==response.errorId&&($scope.errorMsg=response.errorMsg,$scope.isLoadingApp=!1,$scope.numOfApps=response.myApps.length,$scope.numOfApps>0&&($scope.myApps=response.myApps.sort(function(a,b){return a.createdAt>=b.createdAt}),$scope.selectedApp=$scope.myApps[0],$scope.isDisabled=!1))})},$scope.chooseMyApp=function(appInfo){if(1!=appInfo.isBinlding){var searchUrl="myapp/add";appInfo.isBinlding=!0,$http.post(searchUrl,{appInfo:appInfo}).success(function(response){if(appInfo.isBinlding=!1,0==response.errorId||void 0===response.errorId){appInfo.isMine=!0;var flag=0;void 0==$scope.myApps&&($scope.myApps=new Array);for(var i=0;i<$scope.myApps.length;i++){var app=$scope.myApps[i];if(app.appleId==appInfo.appleId){flag=1;break}}0==flag&&($scope.selectedApp=response.newApp,$scope.isDisabled=!1,getDemand(),$scope.myApps.push(response.newApp),console.log($scope.myApps),$scope.numOfApps++)}else $scope.errorMsg=response.errorMsg;$scope.searchKey="",$scope.appResults=[],$("#addApp_modal").modal("hide")})}},$scope.releaseBtnClick=function(app){$scope.prepareReleaseApp=app},$scope.releaseMyApp=function(){var searchUrl="myapp/delete",appid=$scope.prepareReleaseApp.appleId;$http.post(searchUrl,{appid:appid}).success(function(response){if(0==response.errorId){console.log("remove app if");for(var i=0;i<$scope.myApps.length;i++){var app=$scope.myApps[i];if(app.appleId==appid){$scope.myApps.splice(i,1);break}}}else $scope.errorMsg=response.errorMsg;$scope.appResults=[],$scope.numOfApps--,0==$scope.numOfApps?($scope.selectedApp=void 0,getDemand()):$scope.prepareReleaseApp==$scope.selectedApp&&($scope.selectedApp=$scope.myApps[0],$scope.isDisabled=!1,getDemand())})},$scope.saved=!1;var saveNetLock=!1;$scope.saveNeed=function(){if(void 0==$scope.selectedApp||void 0==$scope.selectedApp.appleId)return $scope.modelStr="未选择换评的App,检查一下吧",void $("#error").modal("show");if(void 0==$scope.selectedApp.trackName||0==$scope.selectedApp.length)return $scope.modelStr="选择换评的App信息错误,需要联系客服哦",void $("#error").modal("show");if(1==saveNetLock)return void console.log("保存中...");var needUrl="/myapp/taskneed/"+$scope.selectedApp.appObjectId,needInfo={taskType:$scope.appNeedInfo.taskType,excCount:$scope.appNeedInfo.excCount,excUnitPrice:$scope.appNeedInfo.excUnitPrice,screenshotCount:$scope.appNeedInfo.screenshotCount,searchKeyword:$scope.appNeedInfo.searchKeyword,ranKing:$scope.appNeedInfo.ranKing,Score:$scope.appNeedInfo.Score,titleKeyword:$scope.appNeedInfo.titleKeyword,commentKeyword:$scope.appNeedInfo.commentKeyword,detailRem:$scope.appNeedInfo.detailRem};saveNetLock=!0,$http.post(needUrl,needInfo).success(function(response){$scope.errorId=response.errorId,$scope.errorMsg=response.errorMsg,$scope.saved=!1,saveNetLock=!1})},$scope.checkRank=function(){$scope.appNeedInfo.ranKing>50?$scope.errorCheck=!0:$scope.errorCheck=!1},$scope.releaseTask=function(){$scope.isDisabled=!0,$scope.saveNeed();var flag=!0;if($scope.error=Object(),$scope.error.excCount=!1,$scope.error.searchKeyword=!1,void 0==$scope.appNeedInfo)flag=!1,$("#error").modal("show");else if(void 0!=$scope.appNeedInfo.excCount&&""!=$scope.appNeedInfo.excCount||(flag=!1,$scope.isDisabled=!1,$scope.error.excCount=!0,$scope.modelStr="您有未填写完整的信息",$("#error").modal("show")),""!=$scope.appNeedInfo.searchKeyword&&void 0!=$scope.appNeedInfo.searchKeyword||(flag=!1,$scope.isDisabled=!1,$scope.error.searchKeyword=!0,$scope.modelStr="您有未填写完整的信息",$("#error").modal("show")),$scope.appNeedInfo.excCount>50&&(flag=!1,$scope.isDisabled=!1,$scope.modelStr="任务条数暂时最多50条哦",$("#error").modal("show")),$scope.appNeedInfo.ranKing>50&&(flag=!1,$scope.isDisabled=!1,$scope.modelStr="关键字搜索排名要在50名以内哦",$("#error").modal("show")),void 0!=$scope.appNeedInfo.excCount){var taskMoney=$scope.appNeedInfo.excCount*$scope.appNeedInfo.excUnitPrice;console.log($scope.usermoney),taskMoney>$scope.usermoney&&($scope.modelStr="你的Y币余额不足",$("#error").modal("show"),flag=!1,$scope.isDisabled=!1)}if((void 0==$scope.selectedApp||void 0==$scope.selectedApp.appObjectId||$scope.selectedApp.appObjectId.length<0)&&(flag=!1,$scope.isDisabled=!1,$scope.modelStr="未选择换评的App,检查一下吧",$("#error").modal("show")),void 0==$scope.selectedApp.trackName||void 0==$scope.selectedApp.artworkUrl512)return $scope.modelStr="选择换评的App信息错误,需要联系客服哦",void $("#error").modal("show");if(flag){var needUrl="/myapp/task",needInfo={taskType:$scope.appNeedInfo.taskType,excCount:$scope.appNeedInfo.excCount,excUnitPrice:document.getElementById("price").value,screenshotCount:$scope.appNeedInfo.screenshotCount,searchKeyword:$scope.appNeedInfo.searchKeyword,ranKing:$scope.appNeedInfo.ranKing,Score:$scope.appNeedInfo.Score,titleKeyword:$scope.appNeedInfo.titleKeyword,commentKeyword:$scope.appNeedInfo.commentKeyword,detailRem:$scope.appNeedInfo.detailRem,appObjectId:$scope.selectedApp.appObjectId};$http.post(needUrl,needInfo).success(function(response){$scope.errorId=response.errorId,$scope.errorMsg=response.errorMsg,0!=response.errorId?($scope.modelStr=response.errorMsg,$("#error").modal("show")):$("#releaseTask").modal("show")})}},$scope.Confirm=function(){},$scope.color={color:"#3498db","font-size":"14px"},$scope.checkText1=function(){$scope.appNeedInfo.titleKeyword.length>20&&($scope.appNeedInfo.titleKeyword=$scope.appNeedInfo.titleKeyword.substr(0,20),saveStatusChange())},$scope.checkText2=function(){$scope.appNeedInfo.commentKeyword.length>40&&($scope.appNeedInfo.commentKeyword=$scope.appNeedInfo.commentKeyword.substr(0,40),saveStatusChange())},$scope.checkText3=function(){$scope.appNeedInfo.detailRem.length>140&&($scope.appNeedInfo.detailRem=$scope.appNeedInfo.detailRem.substr(0,140),saveStatusChange())},$scope.calcuQuantity=function(){$scope.appNeedInfo.excCount>20?$scope.errorQuatity=!0:$scope.errorQuatity=!1;var url="myapp/verify";$http.get(url).success(function(response){$scope.usermoney=response.usermoney,moneyCheck($scope.appNeedInfo.excCount,$scope.usermoney)}),$scope.saved=!1},$scope.getScreenShot=function(){html2canvas(document.getElementById("screenShot"),{onrendered:function(canvas){var a=document.createElement("a");a.href=canvas.toDataURL("image/png",1).replace("image/png","image/octet-stream"),a.download="exchange-requirements.png",a.click()},proxy:$scope.selectedApp.artworkUrl100})},$scope.addApp=function(id){$("#"+id).popover("toggle")},$scope.saveStatusChange=function(){$scope.saved=!1},$scope.taskTypeChanged=function(){"评论"==$scope.appNeedInfo.taskType?$scope.appNeedInfo.excUnitPrice=30:$scope.appNeedInfo.excUnitPrice=20,$scope.saved=!1}});