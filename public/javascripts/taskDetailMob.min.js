var app=angular.module("yemaWebApp",["angularFileUpload"]),navIndex=2;app.controller("taskDetailMobControl",function($scope,$http,$location,FileUploader){function blobToDataURI(addedFileItems,dealIndex){console.log("runned");var reader=new FileReader;reader.addEventListener("load",function(event){var aImg=event.target.result;compression(aImg,addedFileItems,dealIndex)},!1),reader.readAsDataURL(addedFileItems[dealIndex]._file)}function compression(dataURI,addedFileItems,dealIndex){var source_img=new Image;source_img.src=dataURI,source_img.onload=function(){var cvs=document.createElement("canvas");cvs.width=source_img.naturalWidth,cvs.height=source_img.naturalHeight,cvs.getContext("2d").drawImage(source_img,0,0);var quality=.3,new_img=cvs.toDataURL("image/jpg",quality),compressImg=dataURItoBlob(new_img);addedFileItems[dealIndex]._file=compressImg,dealIndex++,console.log("compressed"),dealIndex==addedFileItems.length?($scope.progressNum=50,uploader.uploadAll()):blobToDataURI(addedFileItems,dealIndex)}}function dataURItoBlob(dataURI){for(var byteString=atob(dataURI.split(",")[1]),ab=new ArrayBuffer(byteString.length),ia=new Uint8Array(ab),i=0;i<byteString.length;i++)ia[i]=byteString.charCodeAt(i);return new Blob([ab],{type:"image/jpeg"})}var appurlList=$location.absUrl().split("/"),excTaskId=appurlList[appurlList.length-1],detailUrl="/taskDetailMobile/single/"+excTaskId;$http.get(detailUrl).success(function(response){$scope.oneAppInfo=response.oneAppInfo,$scope.images=response.macTask});var uploader=$scope.uploader=new FileUploader({url:"/upload/img",queueLimit:3});uploader.filters.push({name:"imageFilter",fn:function(item,options){var type="|"+item.type.slice(item.type.lastIndexOf("/")+1)+"|";return"|jpg|png|jpeg|".indexOf(type)!==-1}}),$scope.deletFile=function(){uploader.clearQueue()};var fileUrls=new Array;uploader.onAfterAddingFile=function(fileItem){},uploader.onAfterAddingAll=function(addedFileItems){$scope.progressNum=10,blobToDataURI(addedFileItems,0),console.info("onAfterAddingAll",addedFileItems)},uploader.onProgressAll=function(progress){console.info("onProgressAll",progress)},uploader.onSuccessItem=function(fileItem,response,status,headers){console.info("onSuccessItem",fileItem,response,status,headers)},uploader.onErrorItem=function(fileItem,response,status,headers){console.info("onErrorItem",fileItem,response,status,headers)},uploader.onCancelItem=function(fileItem,response,status,headers){console.info("onCancelItem",fileItem,response,status,headers)},uploader.onCompleteItem=function(fileItem,response,status,headers){fileUrls.push(response.fileUrlList[0]),console.info("onCompleteItem",fileItem,response,status,headers)},uploader.onCompleteAll=function(){console.info("onCompleteAll");var appUrl="/taskDetailMobile/addTask/"+$scope.oneAppInfo.taskObjectId;$scope.progressNum=80,$http.post(appUrl,{uploadName:$scope.uploadName,requirementImgs:fileUrls}).success(function(response){$scope.errorId=response.errorId,$scope.errorMsg=response.errorMsg,$scope.oneAppInfo.uploadName=response.uploadName,$scope.images=response.requirementImgs,$scope.progressNum=0,uploader.clearQueue(),fileUrls=new Array})},console.info("uploader",uploader),$scope.normalBtnShow=1,getCookie("uploadImgName").length>0?$scope.normalBtnShow=0:$scope.normalBtnShow=1,$scope.saveUploadName=function(){void 0!=$scope.uploadName&&$scope.uploadName.length>0?($scope.uploadNameError="",$scope.normalBtnShow=0):$scope.uploadNameError="昵称不能为空"},$scope.commitConfirm=function(){location.href="/dailyTask/"+$scope.oneAppInfo.userObjectId}});