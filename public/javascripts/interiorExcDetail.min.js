var app=angular.module("yemaWebApp",["angularFileUpload"]),navIndex=2;app.controller("interorDetailControl",function($scope,$http,$location,FileUploader){var appurlList=$location.absUrl().split("/"),excTaskId=appurlList[appurlList.length-1],Url="interior/"+excTaskId;$http.get(Url).success(function(response){$scope.oneAppInfo=response.oneAppInfo;for(var i=0;i<response.macTasks.length;i++)"uploaded"==response.macTasks[i].status||"reUploaded"==response.macTasks[i].status?response.macTasks[i].status="待审":"rejected"==response.macTasks[i].status||"refused"==response.macTasks[i].status?response.macTasks[i].status="拒绝":"accepted"==response.macTasks[i].status||"systemAccepted"==response.macTasks[i].status?response.macTasks[i].status="已完成":"expired"==response.macTasks[i].status?response.macTasks[i].status="已过期":response.macTasks[i].status="";if($scope.taskInfo=response.macTasks,void 0!=$scope.taskInfo){$scope.progressBarCtrl=new Array($scope.taskInfo.length);for(var j=0;j<response.macTasks.length;j++)$scope.progressBarCtrl[j]=!1}$scope.nextTaskNum=$scope.oneAppInfo.totalExcCount-$scope.oneAppInfo.tasksRemain+1}),$scope.setUploaderName=function(name,index){void 0==name?$scope.uploaderName="批量传图"+parseInt($scope.nextTaskNum):$scope.uploaderName=name,$scope.progressBarIndex=index,console.log(index)};var uploader=$scope.uploader=new FileUploader({url:"/upload/img",queueLimit:3}),fileUrls=new Array;uploader.onWhenAddingFileFailed=function(item,filter,options){console.info("onWhenAddingFileFailed",item,filter,options)},uploader.onAfterAddingFile=function(fileItem){console.info("onAfterAddingFile",fileItem)},uploader.onAfterAddingAll=function(addedFileItems){console.info("onAfterAddingAll",addedFileItems),$scope.progressBarCtrl[$scope.progressBarIndex]=!0,console.log($scope.progressBarCtrl),$scope.errorId=0,$scope.progressNum=5,uploader.uploadAll()},uploader.onBeforeUploadItem=function(item){console.info("onBeforeUploadItem",item)},uploader.onProgressItem=function(fileItem,progress){console.info("onProgressItem",fileItem,progress)},uploader.onProgressAll=function(progress){$scope.progressNum=.8*progress>10?.8*progress:10,console.info("onProgressAll",progress)},uploader.onSuccessItem=function(fileItem,response,status,headers){console.info("onSuccessItem",fileItem,response,status,headers)},uploader.onErrorItem=function(fileItem,response,status,headers){console.info("onErrorItem",fileItem,response,status,headers)},uploader.onCancelItem=function(fileItem,response,status,headers){console.info("onCancelItem",fileItem,response,status,headers)},uploader.onCompleteItem=function(fileItem,response,status,headers){console.info("onCompleteItem",fileItem,response,status,headers),void 0!=response.fileUrlList&&response.fileUrlList.length>0?(fileUrls.push(response.fileUrlList[0]),console.info("onCompleteItem",fileItem,response,status,headers)):($scope.errorId=-100,$scope.errorMsg="网络异常,图片上传错误,刷新网页重新上传")},uploader.onCompleteAll=function(){console.info("onCompleteAll");var url="/interiorExcDetail/add/"+excTaskId;$scope.progressNum=90,$http.post(url,{uploadName:$scope.uploaderName,requirementImgs:fileUrls}).success(function(response){if($scope.errorId=response.errorId,$scope.errorMsg=response.errorMsg,console.log($scope.errorId),console.log($scope.errorMsg),$scope.progressBarCtrl[$scope.progressBarIndex]=!1,$scope.progressNum=0,uploader.clearQueue(),fileUrls=Array(),0==$scope.errorId){var url="refresh/"+excTaskId;$http.get(url).success(function(response){for(var i=0;i<response.macTasks.length;i++)"uploaded"==response.macTasks[i].status||"reUploaded"==response.macTasks[i].status?response.macTasks[i].status="待审":"rejected"==response.macTasks[i].status||"refused"==response.macTasks[i].status?response.macTasks[i].status="拒绝":"accepted"==response.macTasks[i].status||"systemAccepted"==response.macTasks[i].status?response.macTasks[i].status="已完成":"expired"==response.macTasks[i].status?response.macTasks[i].status="已过期":response.macTasks[i].status="";if($scope.taskInfo=response.macTasks,$scope.oneAppInfo.tasksRemain=response.taskRemain,void 0!=$scope.taskInfo){$scope.progressBarCtrl=new Array($scope.taskInfo.length);for(var j=0;j<$scope.taskInfo.length;j++)$scope.progressBarCtrl[j]=!1}console.log($scope.oneAppInfo.tasksRemain),console.log($scope.nextTaskNum),$scope.nextTaskNum=$scope.oneAppInfo.totalExcCount-$scope.oneAppInfo.tasksRemain+1})}})},console.info("uploader",uploader),$scope.commitConfirm=function(){location.href="/myClaim/"+$scope.oneAppInfo.userObjectId}});