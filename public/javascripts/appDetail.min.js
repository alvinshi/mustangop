var app=angular.module("yemaWebApp",["angularFileUpload","ui.router"]),navIndex=4;app.config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state("appDetail",{url:"/",templateUrl:"/html/appDetail-demand.html",controller:"myAppControl"}).state("appDetail-addTask",{url:"/add",templateUrl:"/html/appDetail-addtask.html",controller:"myAppControl"}).state("appDetail-progress",{url:"/progress",templateUrl:"/html/appDetail-progress.html",controller:"myAppControl"}).state("appDetail-curHistory",{url:"/curHistory",templateUrl:"/html/appDetail-curHistory.html",controller:"myAppControl"}).state("appDetail-preHistory",{url:"/preHistory",templateUrl:"/html/appDetail-preHistory.html",controller:"myAppControl"}),$urlRouterProvider.otherwise("/")}]),app.controller("myAppControl",function($scope,$http,$location,FileUploader){$scope.pageIndex=0;var appurlList=$location.absUrl().split("/");if(5==appurlList.length)var appid=appurlList[appurlList.length-1];else{var app=appurlList[appurlList.length-2].split("#");appid=app[app.length-2]}var myappUrl="baseinfo/"+appid;$http.get(myappUrl).success(function(response){$scope.appBaseInfo=response.appBaseInfo;var historyUrl="/app/myAppExcHistory/"+appid+"/"+$scope.appBaseInfo.version;$http.get(historyUrl).success(function(response){$scope.myExcAllApps=response.myExcAllApps});var exchistoryUrl="/myapp/history/angular/"+appid+"/"+$scope.appBaseInfo.version+"/0";$http.get(exchistoryUrl).success(function(response){$scope.ExcAllApps=response.myExcAllApps,$scope.hasMore=response.hasMore});var oldhistoryUrl="/myapp/oldhistory/angular/"+appid+"/"+$scope.appBaseInfo.version;$http.get(oldhistoryUrl).success(function(response){$scope.myHistoryApps=response.myHistoryApps})}),$scope.keyApp=function(e){var keycode=window.event?e.keyCode:e.which;13==keycode&&$scope.searchLocalHistoryApp()},$scope.searchLocalHistoryApp=function(){if(""!=$scope.searchUrl){var searchUrl="/app/historySearch/angular/"+$scope.appBaseInfo.version+"/"+$scope.searchkey;$http.get(searchUrl).success(function(response){console.log("searchLocalHistoryApp "+response.myTotalApps),$scope.ExcAllApps=response.myTotalApps})}},$scope.keySearchApp=function(e){var keycode=window.event?e.keyCode:e.which;13==keycode&&$scope.searchHistoryApp()},$scope.releaseBtnClick=function(appid,appversion){$scope.prepareReleaseAppid=appid,$scope.prepareReleaseVersion=appversion},$scope.removeHistory=function(){var releaseHistoryUrl="/myapp/history/delete",myAppId=$scope.appBaseInfo.appleId,myAppVersion=$scope.appBaseInfo.version,postParam={myAppId:myAppId,myAppVersion:myAppVersion,hisAppId:$scope.prepareReleaseAppid,hisAppVersion:$scope.prepareReleaseVersion};console.log("add history"+postParam),$http.post(releaseHistoryUrl,postParam).success(function(response){if(0==response.errorId){if(console.log("remove app if"),void 0!=$scope.appResults)for(var q=0;q<$scope.appResults.length;q++){var appRe=$scope.appResults[q];if(appRe.appleId===$scope.prepareReleaseAppid){appRe.isExced=!1,console.log(appRe.appleId+"is exchanged");break}}for(var i=0;i<$scope.myExcAllApps.length;i++){var app=$scope.myExcAllApps[i];if(app.appleId==$scope.prepareReleaseAppid){console.log("remove app to ui"),$scope.myExcAllApps.splice(i,1);break}}$scope.errorMsg=""}else console.log("remove app else"),$scope.errorMsg=response.errorMsg})},$scope.removeTodayHistory=function(appid,appversion){$scope.prepareReleaseAppid=appid,$scope.prepareReleaseVersion=appversion},$scope.releaseHistory=function(){var releaseHistoryUrl="/myapp/history/delete",myAppId=$scope.appBaseInfo.appleId,myAppVersion=$scope.appBaseInfo.version,postParam={myAppId:myAppId,myAppVersion:myAppVersion,hisAppId:$scope.prepareReleaseAppid,hisAppVersion:$scope.prepareReleaseVersion};console.log("add history"+postParam),$http.post(releaseHistoryUrl,postParam).success(function(response){if(0==response.errorId){if(console.log("remove app if"),void 0!=$scope.appResults)for(var q=0;q<$scope.appResults.length;q++){var appRe=$scope.appResults[q];if(appRe.appleId===$scope.prepareReleaseAppid){appRe.isExced=!1,console.log(appRe.appleId+"is exchanged");break}}for(var i=0;i<$scope.ExcAllApps.length;i++){var app=$scope.ExcAllApps[i];if(app.appleId==$scope.prepareReleaseAppid){console.log("remove app to ui"),$scope.ExcAllApps.splice(i,1);break}}$scope.errorMsg=""}else console.log("remove app else"),$scope.errorMsg=response.errorMsg})},$scope.removePreHistory=function(appid,appversion){$scope.prepareReleaseAppid=appid,$scope.prepareReleaseVersion=appversion},$scope.releasePreHistory=function(){var releaseHistoryUrl="/myapp/oldhistory/delete",myAppId=$scope.appBaseInfo.appleId,myAppVersion=$scope.appBaseInfo.version,postParam={myAppId:myAppId,myAppVersion:myAppVersion,hisAppId:$scope.prepareReleaseAppid,hisAppVersion:$scope.prepareReleaseVersion};$http.post(releaseHistoryUrl,postParam).success(function(response){if(0==response.errorId){console.log("remove app if");for(var i=0;i<$scope.myHistoryApps.length;i++){var app=$scope.myHistoryApps[i];if(app.appleId==$scope.prepareReleaseAppid){console.log("remove app to ui"),$scope.myHistoryApps.splice(i,1);break}}$scope.errorMsg=""}else console.log("remove app else"),$scope.errorMsg=response.errorMsg})},$scope.nextPageForm=function(){$scope.pageIndex=$scope.pageIndex+20;var historyUrl="/myapp/history/angular/"+appid+"/"+$scope.appBaseInfo.version+"/"+$scope.pageIndex;$http.get(historyUrl).success(function(response){$scope.hasMore=response.hasMore,$scope.ExcAllApps=$scope.ExcAllApps.concat(response.myExcAllApps)})},$scope.pageSize=6,$scope.pagedItems=[],$scope.currentPage=0,$scope.prevPage=function(){$scope.currentPage>0&&$scope.currentPage--},$scope.nextPage=function(){$scope.currentPage<$scope.pagedItems.length-1&&$scope.currentPage++},$scope.searchHistoryApp=function(){if($scope.isError=0,$scope.progressNum=100,""!=$scope.searchUrl){var searchUrl="/myapp/addHistory/"+appid+"/"+$scope.appBaseInfo.version+"/"+$scope.searchKey;$http.get(searchUrl).success(function(response){for(var totalList=response.appResults,e=0;e<totalList.length;e++)e%$scope.pageSize===0?$scope.pagedItems[Math.floor(e/$scope.pageSize)]=[totalList[e]]:$scope.pagedItems[Math.floor(e/$scope.pageSize)].push(totalList[e]);$scope.progressNum=0,response.errorMsg.length>0?($scope.isError=1,$scope.errorMsg=response.errorMsg):($scope.errorMsg="",0==totalList.length&&($scope.isError=1,$scope.errorMsg="未找到你搜索的App"))})}},$scope.addHistory=function(hisAppInfo){var addHistoryUrl="/myapp/addHistory/"+appid+"/"+$scope.appBaseInfo.version,postParam={hisAppInfo:hisAppInfo,excHistoryAdd:"FXS"};$http.post(addHistoryUrl,postParam).success(function(response){if($scope.isError=response.errorId,0==response.errorId||void 0===response.errorId){void 0==$scope.myExcAllApps&&($scope.myExcAllApps=new Array);for(var u=0;u<$scope.pagedItems.length;u++)for(var appRe=$scope.pagedItems[u],d=0;d<appRe.length;d++){var appObject=appRe[d];if(appObject.appleId===hisAppInfo.appleId){appObject.isExced=!0,console.log(appObject.appleId+"is exchanged");break}}$scope.myExcAllApps.unshift(response.addExcObject),$scope.errorMsg=""}else $scope.errorMsg=response.errorMsg})},$scope.addExcHistory=function(hisAppInfo){var addHistoryUrl="/myapp/addHistory/"+appid+"/"+$scope.appBaseInfo.version;console.log("-----* "+addHistoryUrl);var postParam={hisAppInfo:hisAppInfo,excHistoryAdd:"excHistoryadd"};console.log("add history"+postParam),$http.post(addHistoryUrl,postParam).success(function(response){if($scope.isError=response.errorId,console.log(response.errorId),0==response.errorId||void 0===response.errorId){void 0==$scope.ExcAllApps&&($scope.ExcAllApps=new Array);for(var u=0;u<$scope.pagedItems.length;u++)for(var appRe=$scope.pagedItems[u],d=0;d<appRe.length;d++){var appObject=appRe[d];if(appObject.appleId===hisAppInfo.appleId){appObject.isExced=!0,console.log(appObject.appleId+"is exchanged");break}}$scope.ExcAllApps.unshift(response.addExcObject),$scope.errorMsg=""}else $scope.errorMsg=response.errorMsg})};var prepareSaveApp=void 0,uploader=$scope.uploader=new FileUploader({url:"/upload/img",queueLimit:1,removeAfterUpload:!0});$scope.saveTask=function(app){return prepareSaveApp=app,prepareSaveApp.errorMsg="",void 0==prepareSaveApp.excKinds||void 0==prepareSaveApp.totalExcCount?void(prepareSaveApp.errorMsg="类型和交换总数必须填哦"):prepareSaveApp.totalExcCount<1?void(prepareSaveApp.errorMsg="交换条数必须大于0"):uploader.queue.length<1?void(prepareSaveApp.errorMsg="未选择或更新图片"):void(uploader.isUploading?$scope.saveMgs="请等待上个任务保存成功":(prepareSaveApp.upload=uploader,prepareSaveApp.requestNet=1,uploader.uploadItem(uploader.queue[uploader.queue.length-1])))},$scope.deletFile=function(app){uploader.clearQueue(),void 0!=prepareSaveApp&&(prepareSaveApp.prepareUploadFiles=void 0,prepareSaveApp.requirementImg="",prepareSaveApp.uploadingSucceed=0),prepareSaveApp=app,prepareSaveApp.requirementImg="",prepareSaveApp.errorMsg=""},uploader.filters.push({name:"imageFilter",fn:function(item,options){var type="|"+item.type.slice(item.type.lastIndexOf("/")+1)+"|";return-1!=="|jpg|png|jpeg|".indexOf(type)}}),uploader.onAfterAddingFile=function(fileItem){console.info("onAfterAddingFile",fileItem)},uploader.onAfterAddingAll=function(addedFileItems){prepareSaveApp.prepareUploadFiles=addedFileItems,console.info("onAfterAddingAll",addedFileItems)},uploader.onBeforeUploadItem=function(item){console.info("onBeforeUploadItem",item)},uploader.onProgressItem=function(fileItem,progress){console.info("onProgressItem",fileItem,progress)},uploader.onProgressAll=function(progress){console.info("onProgressAll",progress)},uploader.onSuccessItem=function(fileItem,response,status,headers){console.info("onSuccessItem",fileItem,response,status,headers)},uploader.onErrorItem=function(fileItem,response,status,headers){console.info("onErrorItem",fileItem,response,status,headers)},uploader.onCancelItem=function(fileItem,response,status,headers){console.info("onCancelItem",fileItem,response,status,headers)},uploader.onCompleteItem=function(fileItem,response,status,headers){console.info("onCompleteItem",fileItem,response,status,headers);var appUrl="excTaskId/"+prepareSaveApp.appExcTaskObjectID;$http.post(appUrl,{excKinds:prepareSaveApp.excKinds,totalExcCount:prepareSaveApp.totalExcCount,requirementImg:response.fileUrlList[0],addTaskPer:prepareSaveApp.addTaskPer}).success(function(response){prepareSaveApp.requestNet=0,prepareSaveApp.prepareUploadFiles=[],prepareSaveApp.errorId=response.errorId,prepareSaveApp.errorMsg=response.errorMsg,prepareSaveApp.uploadingSucceed=1,prepareSaveApp.requirementImg=response.fileUrlList[0]}),location.href="/app/"+appid},uploader.onCompleteAll=function(){console.info("onCompleteAll")},console.info("uploader",uploader),$scope.color={color:"#3498db"},$scope.getScreenShot=function(){html2canvas(document.getElementById("screenShot"),{onrendered:function(canvas){var a=document.createElement("a");a.href=canvas.toDataURL("image/png",1).replace("image/png","image/octet-stream"),a.download="exchange-requirements.png",a.click()},proxy:$scope.appBaseInfo.artworkUrl100})};var getneedUrl="/app/getNeed/"+appid;$http.get(getneedUrl).success(function(response){$scope.appNeedInfo=response.appNeedInfo}),$scope.saveNeed=function(){var needUrl="/app/taskneed/"+appid,needInfo={taskType:$scope.appNeedInfo.taskType,excCount:$scope.appNeedInfo.excCount,excUnitPrice:$scope.appNeedInfo.excUnitPrice,screenshotCount:$scope.appNeedInfo.screenshotCount,searchKeyword:$scope.appNeedInfo.searchKeyword,ranKing:$scope.appNeedInfo.ranKing,Score:$scope.appNeedInfo.Score,titleKeyword:$scope.appNeedInfo.titleKeyword,commentKeyword:$scope.appNeedInfo.commentKeyword,detailRem:$scope.appNeedInfo.detailRem};$http.post(needUrl,needInfo).success(function(response){$scope.errorId=response.errorId,$scope.errorMsg=response.errorMsg})},$scope.releaseTask=function(){var needUrl="/app/task/"+appid,needInfo={taskType:$scope.appNeedInfo.taskType,excCount:$scope.appNeedInfo.excCount,excUnitPrice:$scope.appNeedInfo.excUnitPrice,screenshotCount:$scope.appNeedInfo.screenshotCount,searchKeyword:$scope.appNeedInfo.searchKeyword,ranKing:$scope.appNeedInfo.ranKing,Score:$scope.appNeedInfo.Score,titleKeyword:$scope.appNeedInfo.titleKeyword,commentKeyword:$scope.appNeedInfo.commentKeyword,detailRem:$scope.appNeedInfo.detailRem,appObjectId:$scope.appBaseInfo.appObjectId};$http.post(needUrl,needInfo).success(function(response){$scope.errorId=response.errorId,$scope.errorMsg=response.errorMsg})}});