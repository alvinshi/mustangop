var app=angular.module("yemaWebApp",["angularFileUpload","ui.router"]),navIndex=4;app.config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("appDetail",{url:"/",templateUrl:"/html/appDetail-demand.html",controller:"myAppControl"}).state("appDetail-addTask",{url:"/add",templateUrl:"/html/appDetail-addtask.html",controller:"myAppControl"}).state("appDetail-progress",{url:"/progress",templateUrl:"/html/appDetail-progress.html",controller:"myAppControl"}).state("appDetail-curHistory",{url:"/curHistory",templateUrl:"/html/appDetail-curHistory.html",controller:"myAppControl"}).state("appDetail-preHistory",{url:"/preHistory",templateUrl:"/html/appDetail-preHistory.html",controller:"myAppControl"}),b.otherwise("/")}]),app.controller("myAppControl",function(a,b,c,d){a.pageIndex=0;var e=c.absUrl().split("/");if(5==e.length)var f=e[e.length-1];else var g=e[e.length-2].split("#"),f=g[g.length-2];console.log("-----"+f);var h="baseinfo/"+f;b.get(h).success(function(c){a.appBaseInfo=c.appBaseInfo;var d="/app/myAppExcHistory/"+f+"/"+a.appBaseInfo.version;b.get(d).success(function(b){a.myExcAllApps=b.myExcAllApps});var e="/myapp/history/angular/"+f+"/"+a.appBaseInfo.version+"/0";b.get(e).success(function(b){a.ExcAllApps=b.myExcAllApps,a.hasMore=b.hasMore});var g="/myapp/oldhistory/angular/"+f+"/"+a.appBaseInfo.version;b.get(g).success(function(b){a.myHistoryApps=b.myHistoryApps})}),a.keyApp=function(b){var c=window.event?b.keyCode:b.which;13==c&&a.searchLocalHistoryApp()},a.searchLocalHistoryApp=function(){if(""!=a.searchUrl){var c="/app/historySearch/angular/"+a.appBaseInfo.version+"/"+a.searchkey;b.get(c).success(function(b){console.log("searchLocalHistoryApp "+b.myTotalApps),a.ExcAllApps=b.myTotalApps})}},a.keySearchApp=function(b){var c=window.event?b.keyCode:b.which;13==c&&a.searchHistoryApp()},a.releaseBtnClick=function(b,c){a.prepareReleaseAppid=b,a.prepareReleaseVersion=c},a.removeHistory=function(){var c="/myapp/history/delete",d=a.appBaseInfo.appleId,e=a.appBaseInfo.version,f={myAppId:d,myAppVersion:e,hisAppId:a.prepareReleaseAppid,hisAppVersion:a.prepareReleaseVersion};console.log("add history"+f),b.post(c,f).success(function(b){if(0==b.errorId){if(console.log("remove app if"),void 0!=a.appResults)for(var c=0;c<a.appResults.length;c++){var d=a.appResults[c];if(d.appleId===a.prepareReleaseAppid){d.isExced=!1,console.log(d.appleId+"is exchanged");break}}for(var e=0;e<a.myExcAllApps.length;e++){var f=a.myExcAllApps[e];if(f.appleId==a.prepareReleaseAppid){console.log("remove app to ui"),a.myExcAllApps.splice(e,1);break}}a.errorMsg=""}else console.log("remove app else"),a.errorMsg=b.errorMsg})},a.removeTodayHistory=function(b,c){a.prepareReleaseAppid=b,a.prepareReleaseVersion=c},a.releaseHistory=function(){var c="/myapp/history/delete",d=a.appBaseInfo.appleId,e=a.appBaseInfo.version,f={myAppId:d,myAppVersion:e,hisAppId:a.prepareReleaseAppid,hisAppVersion:a.prepareReleaseVersion};console.log("add history"+f),b.post(c,f).success(function(b){if(0==b.errorId){if(console.log("remove app if"),void 0!=a.appResults)for(var c=0;c<a.appResults.length;c++){var d=a.appResults[c];if(d.appleId===a.prepareReleaseAppid){d.isExced=!1,console.log(d.appleId+"is exchanged");break}}for(var e=0;e<a.ExcAllApps.length;e++){var f=a.ExcAllApps[e];if(f.appleId==a.prepareReleaseAppid){console.log("remove app to ui"),a.ExcAllApps.splice(e,1);break}}a.errorMsg=""}else console.log("remove app else"),a.errorMsg=b.errorMsg})},a.removePreHistory=function(b,c){a.prepareReleaseAppid=b,a.prepareReleaseVersion=c},a.releasePreHistory=function(){var c="/myapp/oldhistory/delete",d=a.appBaseInfo.appleId,e=a.appBaseInfo.version,f={myAppId:d,myAppVersion:e,hisAppId:a.prepareReleaseAppid,hisAppVersion:a.prepareReleaseVersion};b.post(c,f).success(function(b){if(0==b.errorId){console.log("remove app if");for(var c=0;c<a.myHistoryApps.length;c++){var d=a.myHistoryApps[c];if(d.appleId==a.prepareReleaseAppid){console.log("remove app to ui"),a.myHistoryApps.splice(c,1);break}}a.errorMsg=""}else console.log("remove app else"),a.errorMsg=b.errorMsg})},a.nextPageForm=function(){a.pageIndex=a.pageIndex+20;var c="/myapp/history/angular/"+f+"/"+a.appBaseInfo.version+"/"+a.pageIndex;b.get(c).success(function(b){a.hasMore=b.hasMore,a.ExcAllApps=a.ExcAllApps.concat(b.myExcAllApps)})},a.pageSize=6,a.pagedItems=[],a.currentPage=0,a.prevPage=function(){a.currentPage>0&&a.currentPage--},a.nextPage=function(){a.currentPage<a.pagedItems.length-1&&a.currentPage++},a.searchHistoryApp=function(){if(a.isError=0,a.progressNum=100,""!=a.searchUrl){var c="/myapp/addHistory/"+f+"/"+a.appBaseInfo.version+"/"+a.searchKey;b.get(c).success(function(b){for(var c=b.appResults,d=0;d<c.length;d++)d%a.pageSize===0?a.pagedItems[Math.floor(d/a.pageSize)]=[c[d]]:a.pagedItems[Math.floor(d/a.pageSize)].push(c[d]);a.progressNum=0,b.errorMsg.length>0?(a.isError=1,a.errorMsg=b.errorMsg):(a.errorMsg="",0==c.length&&(a.isError=1,a.errorMsg="未找到你搜索的App"))})}},a.addHistory=function(c){var d="/myapp/addHistory/"+f+"/"+a.appBaseInfo.version,e={hisAppInfo:c,excHistoryAdd:"FXS"};b.post(d,e).success(function(b){if(a.isError=b.errorId,0==b.errorId||void 0===b.errorId){void 0==a.myExcAllApps&&(a.myExcAllApps=new Array);for(var d=0;d<a.pagedItems.length;d++)for(var e=a.pagedItems[d],f=0;f<e.length;f++){var g=e[f];if(g.appleId===c.appleId){g.isExced=!0,console.log(g.appleId+"is exchanged");break}}a.myExcAllApps.unshift(b.addExcObject),a.errorMsg=""}else a.errorMsg=b.errorMsg})},a.addExcHistory=function(c){var d="/myapp/addHistory/"+f+"/"+a.appBaseInfo.version;console.log("-----* "+d);var e={hisAppInfo:c,excHistoryAdd:"excHistoryadd"};console.log("add history"+e),b.post(d,e).success(function(b){if(a.isError=b.errorId,console.log(b.errorId),0==b.errorId||void 0===b.errorId){void 0==a.ExcAllApps&&(a.ExcAllApps=new Array);for(var d=0;d<a.pagedItems.length;d++)for(var e=a.pagedItems[d],f=0;f<e.length;f++){var g=e[f];if(g.appleId===c.appleId){g.isExced=!0,console.log(g.appleId+"is exchanged");break}}a.ExcAllApps.unshift(b.addExcObject),a.errorMsg=""}else a.errorMsg=b.errorMsg})};var i=void 0,j=a.uploader=new d({url:"/upload/img",queueLimit:1,removeAfterUpload:!0});a.saveTask=function(b){return i=b,i.errorMsg="",void 0==i.excKinds||void 0==i.totalExcCount?void(i.errorMsg="类型和交换总数必须填哦"):i.totalExcCount<1?void(i.errorMsg="交换条数必须大于0"):j.queue.length<1?void(i.errorMsg="未选择或更新图片"):void(j.isUploading?a.saveMgs="请等待上个任务保存成功":(i.upload=j,i.requestNet=1,j.uploadItem(j.queue[j.queue.length-1])))},a.deletFile=function(a){j.clearQueue(),void 0!=i&&(i.prepareUploadFiles=void 0,i.requirementImg="",i.uploadingSucceed=0),i=a,i.requirementImg="",i.errorMsg=""},j.filters.push({name:"imageFilter",fn:function(a,b){var c="|"+a.type.slice(a.type.lastIndexOf("/")+1)+"|";return"|jpg|png|jpeg|".indexOf(c)!==-1}}),j.onAfterAddingFile=function(a){console.info("onAfterAddingFile",a)},j.onAfterAddingAll=function(a){i.prepareUploadFiles=a,console.info("onAfterAddingAll",a)},j.onBeforeUploadItem=function(a){console.info("onBeforeUploadItem",a)},j.onProgressItem=function(a,b){console.info("onProgressItem",a,b)},j.onProgressAll=function(a){console.info("onProgressAll",a)},j.onSuccessItem=function(a,b,c,d){console.info("onSuccessItem",a,b,c,d)},j.onErrorItem=function(a,b,c,d){console.info("onErrorItem",a,b,c,d)},j.onCancelItem=function(a,b,c,d){console.info("onCancelItem",a,b,c,d)},j.onCompleteItem=function(a,c,d,e){console.info("onCompleteItem",a,c,d,e);var g="excTaskId/"+i.appExcTaskObjectID;b.post(g,{excKinds:i.excKinds,totalExcCount:i.totalExcCount,requirementImg:c.fileUrlList[0],addTaskPer:i.addTaskPer}).success(function(a){i.requestNet=0,i.prepareUploadFiles=[],i.errorId=a.errorId,i.errorMsg=a.errorMsg,i.uploadingSucceed=1,i.requirementImg=a.fileUrlList[0]}),location.href="/app/"+f},j.onCompleteAll=function(){console.info("onCompleteAll")},console.info("uploader",j),a.color={color:"#3498db"},a.getScreenShot=function(){console.log("runned"),html2canvas(document.getElementById("screenShot"),{onrendered:function(a){var b=document.createElement("a");b.href=a.toDataURL("image/png",1).replace("image/png","image/octet-stream"),b.download="exchange-requirements.png",b.click()},proxy:a.appBaseInfo.artworkUrl100})};var k="/app/getNeed/"+f;b.get(k).success(function(b){a.appNeedInfo=b.appNeedInfo}),a.saveNeed=function(){var c="/app/taskneed/"+f,d={taskType:a.appNeedInfo.taskType,excCount:a.appNeedInfo.excCount,excUnitPrice:a.appNeedInfo.excUnitPrice,screenshotCount:a.appNeedInfo.screenshotCount,searchKeyword:a.appNeedInfo.searchKeyword,ranKing:a.appNeedInfo.ranKing,Score:a.appNeedInfo.Score,titleKeyword:a.appNeedInfo.titleKeyword,commentKeyword:a.appNeedInfo.commentKeyword,detailRem:a.appNeedInfo.detailRem};b.post(c,d).success(function(b){a.errorId=b.errorId,a.errorMsg=b.errorMsg})},a.releaseTask=function(){var c="/app/task/"+f,d={taskType:a.appNeedInfo.taskType,excCount:a.appNeedInfo.excCount,excUnitPrice:a.appNeedInfo.excUnitPrice,screenshotCount:a.appNeedInfo.screenshotCount,searchKeyword:a.appNeedInfo.searchKeyword,ranKing:a.appNeedInfo.ranKing,Score:a.appNeedInfo.Score,titleKeyword:a.appNeedInfo.titleKeyword,commentKeyword:a.appNeedInfo.commentKeyword,detailRem:a.appNeedInfo.detailRem,appObjectId:a.appBaseInfo.appObjectId};b.post(c,d).success(function(b){a.errorId=b.errorId,a.errorMsg=b.errorMsg})}});