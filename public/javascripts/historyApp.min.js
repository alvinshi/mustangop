var app=angular.module("yemaWebApp",["ngSanitize"]),navIndex=1;app.controller("historyAppCtrl",function(a,b,c){a.pageIndex=0,a.progressNum=0,a.hasMore=0,a.selectMyAppIndex=0,a.isLoadingMyApp=!0,console.log("loading historyApp.js"),console.log(c.absUrl());var d=c.absUrl();if(d.indexOf("addHistory")==-1){var e="/myapp/angular";b.get(e).success(function(c){if(a.myApps=c.myApps,a.isLoadingMyApp=!1,a.myApps.length>0){a.selectedApp=a.myApps[0],a.selectedApp.isSelected=!0;var d="/myapp/history/angular/"+a.selectedApp.appleId+"/"+a.selectedApp.version+"/"+a.pageIndex;b.get(d).success(function(b){a.myExcAllApps=b.myExcAllApps,a.hasMore=b.hasMore;var c=document.getElementsByClassName("thumbnail_wrap")[a.selectMyAppIndex];void 0!=c&&(c.style.border="2px solid #3498db",console.log(a.myExcAllApps))});var e="/myapp/oldhistory/angular/"+a.selectedApp.appleId+"/"+a.selectedApp.version;b.get(e).success(function(b){a.myHistoryApps=b.myHistoryApps})}}).error(function(b){console.log("error"+b),a.isLoadingMyApp=!1})}a.nextPage=function(){a.pageIndex=a.pageIndex+20;var c="/myapp/history/angular/"+a.selectedApp.appleId+"/"+a.selectedApp.version+"/"+a.pageIndex;b.get(c).success(function(b){a.hasMore=b.hasMore,a.myExcAllApps=a.myExcAllApps.concat(b.myExcAllApps)})},a.selectedAppFunc=function(c){console.log("selected"+c);var d=document.getElementsByClassName("thumbnail_wrap")[a.selectMyAppIndex];d.style.border="2px solid gray";for(var e=0;e<a.myApps.length;e++){var f=a.myApps[e];if(f.appleId==c){a.selectedApp.isSelected=!1,a.selectedApp=f,a.selectMyAppIndex=e;break}}d=document.getElementsByClassName("thumbnail_wrap")[a.selectMyAppIndex],d.style.border="2px solid #3498db",a.pageIndex=0;var g="/myapp/history/angular/"+a.selectedApp.appleId+"/"+a.selectedApp.version+"/"+a.pageIndex;b.get(g).success(function(b){a.myExcAllApps=b.myExcAllApps});var h="/myapp/oldhistory/angular/"+a.selectedApp.appleId+"/"+a.selectedApp.version;b.get(h).success(function(b){a.myHistoryApps=b.myHistoryApps})},a.searchApp=function(){if(""!=a.searchUrl){var c="/api/itunes/search/"+a.searchKey;b.get(c).success(function(b){a.appResults=b.appResults})}},a.searchHistoryApp=function(){if(a.isError=0,""!=a.searchUrl){var d=c.absUrl()+"/"+a.searchKey;a.progressNum=100,b.get(d).success(function(b){console.log(b),a.appResults=b.appResults,a.progressNum=0,b.errorMsg.length>0?(a.isError=1,a.errorMsg=b.errorMsg):(a.errorMsg="",0==a.appResults.length&&(a.isError=1,a.errorMsg="未找到你搜索的App"))})}},a.keySearchApp=function(b){var c=window.event?b.keyCode:b.which;13!=c&&32!=c||a.searchHistoryApp()},a.addAppHistory=function(){var b="/myapp/addHistory/"+a.selectedApp.appleId+"/"+a.selectedApp.version;location.href=b},a.addHistory=function(c){console.log("-----* "+location.href);var d=location.href,e={hisAppInfo:c,excHistoryAdd:"excHistoryadd"};console.log("add history"+e),b.post(d,e).success(function(b){if(a.isError=b.errorId,console.log(b.errorId),0==b.errorId||void 0===b.errorId){void 0==a.myExcAllApps&&(a.myExcAllApps=new Array);for(var d=0;d<a.appResults.length;d++){var e=a.appResults[d];if(e.appleId===c.appleId){e.isExced=!0,console.log(e.appleId+"is exchanged");break}}a.errorMsg=""}else a.errorMsg=b.errorMsg})},a.releaseBtnClick=function(b,c){a.prepareReleaseAppid=b,a.prepareReleaseVersion=c},a.releaseHistory=function(){var c="/myapp/history/delete",d=a.selectedApp.appleId,e=a.selectedApp.version,f={myAppId:d,myAppVersion:e,hisAppId:a.prepareReleaseAppid,hisAppVersion:a.prepareReleaseVersion};b.post(c,f).success(function(b){if(0==b.errorId){if(console.log("remove app if"),void 0!=a.appResults)for(var c=0;c<a.appResults.length;c++){var d=a.appResults[c];if(d.appleId===a.prepareReleaseAppid){d.isExced=!1,console.log(d.appleId+"is exchanged");break}}for(var e=0;e<a.myExcAllApps.length;e++){var f=a.myExcAllApps[e];if(f.appleId==a.prepareReleaseAppid){console.log("remove app to ui"),a.myExcAllApps.splice(e,1);break}}a.errorMsg=""}else console.log("remove app else"),a.errorMsg=b.errorMsg})},a.History=function(c,d){var e="/myapp/oldhistory/delete",f=a.selectedApp.appleId,g=a.selectedApp.version,h={myAppId:f,myAppVersion:g,hisAppId:c,hisAppVersion:d};b.post(e,h).success(function(b){if(0==b.errorId){if(console.log("remove app if"),void 0!=a.appResults)for(var d=0;d<a.appResults.length;d++){var e=a.appResults[d];if(e.appleId===c){e.isExced=!1,console.log(e.appleId+"is exchanged");break}}for(var f=0;f<a.myHistoryApps.length;f++){var g=a.myHistoryApps[f];if(g.appleId==c){console.log("remove app to ui"),a.myHistoryApps.splice(f,1);break}}a.errorMsg=""}else console.log("remove app else"),a.errorMsg=b.errorMsg})}});