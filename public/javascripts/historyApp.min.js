var app=angular.module("yemaWebApp",["ngSanitize"]),navIndex=1;app.controller("historyAppCtrl",function($scope,$http,$location){$scope.pageIndex=0,$scope.progressNum=0,$scope.hasMore=0,$scope.selectMyAppIndex=0,$scope.isLoadingMyApp=!0,console.log("loading historyApp.js"),console.log($location.absUrl());var webUrl=$location.absUrl();if(-1==webUrl.indexOf("addHistory")){var appsUrl="/myapp/angular";$http.get(appsUrl).success(function(response){if($scope.myApps=response.myApps,$scope.isLoadingMyApp=!1,$scope.myApps.length>0){$scope.selectedApp=$scope.myApps[0],$scope.selectedApp.isSelected=!0;var historyUrl="/myapp/history/angular/"+$scope.selectedApp.appleId+"/"+$scope.selectedApp.version+"/"+$scope.pageIndex;$http.get(historyUrl).success(function(response){$scope.myExcAllApps=response.myExcAllApps,$scope.hasMore=response.hasMore;var myAppElemment=document.getElementsByClassName("thumbnail_wrap")[$scope.selectMyAppIndex];void 0!=myAppElemment&&(myAppElemment.style.border="2px solid #3498db",console.log($scope.myExcAllApps))});var oldhistoryUrl="/myapp/oldhistory/angular/"+$scope.selectedApp.appleId+"/"+$scope.selectedApp.version;$http.get(oldhistoryUrl).success(function(response){$scope.myHistoryApps=response.myHistoryApps})}}).error(function(error){console.log("error"+error),$scope.isLoadingMyApp=!1})}$scope.nextPage=function(){$scope.pageIndex=$scope.pageIndex+20;var historyUrl="/myapp/history/angular/"+$scope.selectedApp.appleId+"/"+$scope.selectedApp.version+"/"+$scope.pageIndex;$http.get(historyUrl).success(function(response){$scope.hasMore=response.hasMore,$scope.myExcAllApps=$scope.myExcAllApps.concat(response.myExcAllApps)})},$scope.selectedAppFunc=function(appleId){console.log("selected"+appleId);var myAppElemment=document.getElementsByClassName("thumbnail_wrap")[$scope.selectMyAppIndex];myAppElemment.style.border="2px solid gray";for(var i=0;i<$scope.myApps.length;i++){var tempApp=$scope.myApps[i];if(tempApp.appleId==appleId){$scope.selectedApp.isSelected=!1,$scope.selectedApp=tempApp,$scope.selectMyAppIndex=i;break}}myAppElemment=document.getElementsByClassName("thumbnail_wrap")[$scope.selectMyAppIndex],myAppElemment.style.border="2px solid #3498db",$scope.pageIndex=0;var historyUrl="/myapp/history/angular/"+$scope.selectedApp.appleId+"/"+$scope.selectedApp.version+"/"+$scope.pageIndex;$http.get(historyUrl).success(function(response){$scope.myExcAllApps=response.myExcAllApps});var oldhistoryUrl="/myapp/oldhistory/angular/"+$scope.selectedApp.appleId+"/"+$scope.selectedApp.version;$http.get(oldhistoryUrl).success(function(response){$scope.myHistoryApps=response.myHistoryApps})},$scope.searchApp=function(){if(""!=$scope.searchUrl){var searchUrl="/api/itunes/search/"+$scope.searchKey;$http.get(searchUrl).success(function(response){$scope.appResults=response.appResults})}},$scope.searchHistoryApp=function(){if($scope.isError=0,""!=$scope.searchUrl){var searchUrl=$location.absUrl()+"/"+$scope.searchKey;$scope.progressNum=100,$http.get(searchUrl).success(function(response){console.log(response),$scope.appResults=response.appResults,$scope.progressNum=0,response.errorMsg.length>0?($scope.isError=1,$scope.errorMsg=response.errorMsg):($scope.errorMsg="",0==$scope.appResults.length&&($scope.isError=1,$scope.errorMsg="未找到你搜索的App"))})}},$scope.keySearchApp=function(e){var keycode=window.event?e.keyCode:e.which;13!=keycode&&32!=keycode||$scope.searchHistoryApp()},$scope.addAppHistory=function(){var addHistoryHtmlUrl="/myapp/addHistory/"+$scope.selectedApp.appleId+"/"+$scope.selectedApp.version;location.href=addHistoryHtmlUrl},$scope.addHistory=function(hisAppInfo){console.log("-----* "+location.href);var addHistoryUrl=location.href,postParam={hisAppInfo:hisAppInfo,excHistoryAdd:"excHistoryadd"};console.log("add history"+postParam),$http.post(addHistoryUrl,postParam).success(function(response){if($scope.isError=response.errorId,console.log(response.errorId),0==response.errorId||void 0===response.errorId){void 0==$scope.myExcAllApps&&($scope.myExcAllApps=new Array);for(var i=0;i<$scope.appResults.length;i++){var appRe=$scope.appResults[i];if(appRe.appleId===hisAppInfo.appleId){appRe.isExced=!0,console.log(appRe.appleId+"is exchanged");break}}$scope.errorMsg=""}else $scope.errorMsg=response.errorMsg})},$scope.releaseBtnClick=function(appid,appversion){$scope.prepareReleaseAppid=appid,$scope.prepareReleaseVersion=appversion},$scope.releaseHistory=function(){var releaseHistoryUrl="/myapp/history/delete",myAppId=$scope.selectedApp.appleId,myAppVersion=$scope.selectedApp.version,postParam={myAppId:myAppId,myAppVersion:myAppVersion,hisAppId:$scope.prepareReleaseAppid,hisAppVersion:$scope.prepareReleaseVersion};$http.post(releaseHistoryUrl,postParam).success(function(response){if(0==response.errorId){if(console.log("remove app if"),void 0!=$scope.appResults)for(var q=0;q<$scope.appResults.length;q++){var appRe=$scope.appResults[q];if(appRe.appleId===$scope.prepareReleaseAppid){appRe.isExced=!1,console.log(appRe.appleId+"is exchanged");break}}for(var i=0;i<$scope.myExcAllApps.length;i++){var app=$scope.myExcAllApps[i];if(app.appleId==$scope.prepareReleaseAppid){console.log("remove app to ui"),$scope.myExcAllApps.splice(i,1);break}}$scope.errorMsg=""}else console.log("remove app else"),$scope.errorMsg=response.errorMsg})},$scope.History=function(appid,appversion){var HistoryUrl="/myapp/oldhistory/delete",myAppId=$scope.selectedApp.appleId,myAppVersion=$scope.selectedApp.version,postParam={myAppId:myAppId,myAppVersion:myAppVersion,hisAppId:appid,hisAppVersion:appversion};$http.post(HistoryUrl,postParam).success(function(response){if(0==response.errorId){if(console.log("remove app if"),void 0!=$scope.appResults)for(var q=0;q<$scope.appResults.length;q++){var appRe=$scope.appResults[q];if(appRe.appleId===appid){appRe.isExced=!1,console.log(appRe.appleId+"is exchanged");break}}for(var i=0;i<$scope.myHistoryApps.length;i++){var app=$scope.myHistoryApps[i];if(app.appleId==appid){console.log("remove app to ui"),$scope.myHistoryApps.splice(i,1);break}}$scope.errorMsg=""}else console.log("remove app else"),$scope.errorMsg=response.errorMsg})}});